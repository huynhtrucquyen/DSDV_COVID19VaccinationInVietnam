<!DOCTYPE html>
<meta charset='utf-8'>

<head>
    <script type='text/javascript' src='https://d3js.org/d3.v4.min.js'></script>
    <script type='text/javascript' src='js/geomap.js'></script>
</head>

<style>
    div.tooltip1 {
        position: absolute;
        text-align: center;
        width: auto;
        height: auto;
        padding: 6px;
        font: 15px sans-serif;
        color: rgb(0, 0, 0);
        font-weight: bold;
        background: rgb(206, 255, 198);
        border: 5px;
        border-radius: 8px;
        pointer-events: none;
        opacity: 0.9;
    }
</style>


<body>

    <div id='geomap'></div>

    <script>
        //Width and height of map
        var width = 500
        height = 920;

        //Define map projection
        var projection = d3.geoAlbers()
            .center([100, 4.4])
            .rotate([0, 32])
            .parallels([11, 20])
            .scale([2000])
            .translate([width / 30, height / 1.8]);

        //Define path generator
        var path = d3.geoPath()
            .projection(projection);

        var zoom = d3.zoom()
            .scaleExtent([1, 40])
            .translateExtent([
                [0, 0],
                [width, height]
            ])
            .extent([
                [0, 0],
                [width, height]
            ])
            .on('zoom', zoomed);

        //Create SVG element
        var svg = d3.select('body')
            .append('svg')
            .attr('width', width + 500)
            .attr('height', height)
        var g = svg.append('g');


        // Define the div for the tooltip
        var tooltip1 = d3.select('body').append('div')
            .attr('class', 'tooltip1')
            .style('opacity', 0);

        //Load in data
        d3.csv('https://raw.githubusercontent.com/huynhtrucquyen/DSDV_COVID19VaccinationInVietnam/main/Geomap_vaccine.csv', function(data) {

            //Load GeoJSON data and merge with provinces data
            d3.json('https://raw.githubusercontent.com/TungTh/tungth.github.io/master/data/vn-provinces.json', function(json) {

                //Loop through each province data doses in the .csv file
                for (var i = 0; i < data.length; i++) {

                    //Grab data province 
                    var dataProvince = parseFloat(data[i].ma);
                    console.log(json.features[0].properties.Ma);

                    //Grab data doses
                    var dataC = data[i].doses;

                    //Find the corresponding province inside the GeoJSON
                    for (var j = 0; j < json.features.length; j++) {

                        var jsonProvince = json.features[j].properties.Ma;

                        if (dataProvince == jsonProvince) {

                            //Copy the data doses into the JSON
                            json.features[j].properties.doses = dataC;

                            //Stop looking through the JSON
                            break;
                        }
                    }

                    //Loop to get province name
                    //Grab province name
                    var dataName = data[i].province;

                    //Find the corresponding province inside the GeoJSON
                    for (var k = 0; k < json.features.length; k++) {

                        var jsonProvince = json.features[k].properties.Ma;

                        if (dataProvince == jsonProvince) {

                            //Copy the data doses into the JSON
                            json.features[k].properties.province = dataName;

                            //Stop looking through the JSON
                            break;
                        }
                    }
                }



                //Bind data to the SVG and create one path per GeoJSON feature
                var map = g.selectAll('path')
                    .data(json.features)
                    .enter()
                    .append('path')
                    .attr('d', path)
                    .style('fill', function(d) {
                        value = d.properties.doses;
                        if (value > 10000000) {
                            return 'rgb(14, 90, 7)';
                        } else if (value > 3000000) {
                            return 'rgb(11, 144, 4)';
                        } else if (value > 1000000) {
                            return 'rgb(65, 195, 65)';
                        } else {
                            return 'rgb(190, 255, 179)';
                        }
                    })
                    .on('mouseover', function(d) {
                        d3.select(this)
                            .transition()
                            .duration(200)
                            .style('opacity', 1)
                            .style('stroke', '#404040')
                        tooltip1
                            .transition()
                            .duration(200)
                            .style('opacity', 0.9)
                            .style('stroke', 'black')
                        tooltip1.html(d.province);
                    })
                    .on('mousemove', function(d) {
                        tooltip1
                            .style('top', (d3.event.pageY) + 'px')
                            .style('left', (d3.event.pageX + 10) + 'px')
                        var formatComma = d3.format(',')
                        tooltip1.html(d.properties.province + (' <br>Number of doses injected: ') + formatComma(d.properties.doses));
                    })
                    .on('mouseout', function(d) {
                        d3.select(this)
                            .transition()
                            .duration(200)
                            .style('stroke', 'transparent')
                        tooltip1
                            .transition()
                            .duration(200)
                            .style('opacity', 0);
                    })
            })

        })

        function zoomed() {
            g
                .selectAll('path') // To prevent stroke width from scaling
                .attr('transform', d3.event.transform);
        }
    </script>
</body>

</html>
