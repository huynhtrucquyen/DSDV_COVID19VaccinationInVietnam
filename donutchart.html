<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8' />
    <title>Pie chart</title>
    <link href='//cdnjs.cloudflare.com/ajax/libs/normalize/3.0.1/normalize.min.css' rel='stylesheet' data-semver='3.0.1' data-require='normalize@*' />
    <script type='text/javascript' src='js/donutchart.js'></script>
    <style>
        div.tooltip3 {
            position: absolute;
            text-align: center;
            width: auto;
            height: auto;
            padding: 6px;
            font: 15px sans-serif;
            color: rgb(0, 0, 0);
            font-weight: bold;
            background: rgb(206, 255, 198);
            border: 5px;
            border-radius: 8px;
            pointer-events: none;
            opacity: 0.9;
        }
        
        .legend {
            font-size: 12px;
        }
    </style>
</head>

<body>
    <div id='donutchart'></div>
    <script data-require='d3@*' data-semver='4.0.0' src='https://d3js.org/d3.v4.min.js'></script>
    <script>
        var data = [{
                label: 'AstraZeneca',
                count: 65223076
            }, {
                label: 'Pfizer',
                count: 94324020
            }, {
                label: 'Sinopharm',
                count: 52261200
            }, {
                label: 'Moderna',
                count: 14077160
            }, {
                label: 'Abdala',
                count: 5150000
            }, {
                label: 'Sputnik V',
                count: 1508998
            }

        ];

        // Set dimensions and append svg object to the body of the graph
        var width = 360;
        var height = 360;

        var svg = d3.select('#donutchart')
            .append('svg')
            .attr('width', width + 350)
            .attr('height', height + 200)
            .append('g')
            .attr('transform', 'translate(' + (width / 1.3) + ',' + (height / 1.5) + ')');

        var radius = Math.min(width, height) / 2;
        var donutWidth = 80;
        var innerRadius = radius - donutWidth;
        var outerRadius = radius;
        var outerRadiusFinal = radius * 1.06;
        var legendRectSize = 18;
        var legendSpacing = 4;

        var colorScale = d3.scaleOrdinal(['rgb(51, 153, 102)', 'rgb(102, 153, 153)', 'rgb(0, 102, 102)', 'rgb(0, 204, 153)', 'rgb(0, 153, 153)', 'rgb(0, 204, 102)']);


        var arc = d3.arc()
            .innerRadius(innerRadius)
            .outerRadius(outerRadius);

        // for animation
        var arcFinal = d3.arc()
            .innerRadius(innerRadius)
            .outerRadius(outerRadiusFinal);

        var pie = d3.pie()
            .value(function(d) {
                return d.count;
            })
            .sort(null);

        // Define tooltip3
        var tooltip3 = d3.select('#donutchart')
            .append('div')
            .attr('class', 'tooltip3');

        tooltip3.append('div')
            .attr('class', 'label');

        tooltip3.append('div')
            .attr('class', 'count');

        tooltip3.append('div')
            .attr('class', 'percent');

        // Draw the pie chart
        var path = svg.selectAll('g.slice')
            .data(pie(data))
            .enter()
            .append('svg:g')
            .attr('class', 'slice')

        path.append('svg:path')
            .attr('d', arc)
            .attr('fill', function(d, i) {
                return colorScale(d.data.label);
            })
            .attr('stroke', 'white')
            .style('stroke-width', '1.8px');


        var total = d3.sum(data.map(function(d) {
            return d.count;
        }));
        var formatComma = d3.format(',')
            // tooltip3 and arc transition
        path.on('mouseover', function(d) {
            d3.select(this).select('path').transition()
                .duration(650)
                .attr('d', arcFinal);
            var percent = Math.round(1000 * d.data.count / total) / 10;
            tooltip3.select('.label').html(d.data.label);
            tooltip3.select('.count').html(formatComma(d.data.count));
            tooltip3.select('.percent').html(percent + '%');
            tooltip3.style('display', 'block');
        });

        path.on('mouseout', function() {
            d3.select(this).select('path').transition()
                .duration(650)
                .attr('d', arc);
            tooltip3.style('display', 'none');
        });

        path.on('mousemove', function(d) {
            tooltip3.style('top', (d3.event.pageY + 10) + 'px')
                .style('left', (d3.event.pageX + 10) + 'px');
        });

        // Add a label to the larger arcs, translated to the arc centroid and rotated
        path.filter(function(d) {
                return d.endAngle - d.startAngle > .2;
            })
            .append('svg:text')
            .attr('dy', '.35em')
            .attr('text-anchor', 'middle')
            .attr('transform', function(d) {
                return 'translate(' + arc.centroid(d) + ')rotate(' + angle(d) + ')';
            })


        // Computes the label angle of an arc, converting from radians to degrees
        function angle(d) {
            var a = (d.startAngle + d.endAngle) * 90 / Math.PI - 90;
            return a > 90 ? a - 180 : a;
        }


        var legend = svg.selectAll('.legend')
            .data(colorScale.domain())
            .enter()
            .append('g')
            .attr('class', 'legend')
            .attr('transform', function(d, i) {
                var height = legendRectSize + legendSpacing,
                    horz = legendRectSize + 220,
                    vert = i * height - 150
                return 'translate(' + horz + ',' + vert + ')';
            });
        legend.append('circle')
            .attr('cx', legendRectSize)
            .attr('cy', legendRectSize - 8)
            .attr('r', 8)
            .style('fill', colorScale)

        legend.append('text')
            .attr('x', legendRectSize + legendSpacing + 10)
            .attr('y', legendRectSize - legendSpacing)
            .text(function(d) {
                return d;
            });

        var sum = [total]
        var legend2 = svg.selectAll('.legend2')
            .data(sum)
            .enter()
            .append('g')
            .attr('class', 'legend2')
            .attr('transform', function(d, i) {
                var height = legendRectSize + legendSpacing,
                    horz = legendRectSize - 110,
                    vert = i * height - 15
                return 'translate(' + horz + ',' + vert + ')';
            });
        legend2.append('text')
            .attr('x', legendRectSize + legendSpacing + 10)
            .attr('y', legendRectSize - legendSpacing)
            .text((function(d) {
                return 'Total: ' + formatComma(total);
            }))
    </script>
</body>

</html>
